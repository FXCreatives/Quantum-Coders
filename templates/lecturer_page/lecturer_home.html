<!DOCTYPE html> 
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="{{ url_for('static', filename='\1') }}" type="image/png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css"/>
    <link rel="stylesheet" href="{{ url_for('static', filename='\1') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='\1') }}">
    <title>Lecturer Classes</title>

    <script src="{{ url_for('static', filename='\1') }}"></script>
    <script src="{{ url_for('static', filename='\1') }}"></script>
    <script>
    (function() {
        if (localStorage.getItem("darkMode") === "true") {
            document.documentElement.classList.add("dark-mode");
        }
    })();
    </script>

    <style>
    @import url('https://fonts.googleapis.com/css2?family=Libre+Baskerville:ital,wght@0,400;0,700;1,400&family=Libre+Franklin:ital,wght@0,100..900;1,100..900&display=swap');
    </style>
</head>
<body>

    <!-- Navbar -->
    <section class="nav_bar_section">
        <nav class="navbar">
            <div class="navdiv">
                <div class="logo"></div>
                <div class="nav_links">
                    <button class="theme-toggle" id="themeToggle">
                        <i class="fas fa-moon"></i>
                        <p id="mode-btn" class="mode-btn-text">Dark mode</p>
                    </button>
                    <a href="{{ url_for('lecturer_notification') }}">
                        <i class="far fa-bell"></i>
                        <span>Notification</span>
                    </a>
                    <a href="{{ url_for('lecturer_profile') }}">
                        <i class="far fa-user"></i>
                        <span>Profile</span>
                    </a>
                </div>
            </div>
        </nav>
    </section>

    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
      <div class="sidebar-header">
          <button class="toggle-btn" id="toggleBtn">
            <i class="fas fa-bars"></i>
          </button>
          <h2>Edu-Portal</h2>
      </div>

      <div class="menu">
        <div class="menu-category">Home</div>
        <a href="{{ url_for('lecturer_initial_home') }}" class="menu-item">
          <i class="fas fa-home"></i>
          <span class="menu-text">Home</span>
          <span class="tooltip">Home</span>
        </a>

        <div class="menu-category">Academic</div>
        <a href="#" class="menu-item active">
          <i class="fas fa-book"></i>
          <span class="menu-text">My Classes</span>
          <span class="tooltip">My Classes</span>
        </a>

        <div class="menu-category">Lecturer Info</div>
        <a href="{{ url_for('lecturer_announcements') }}" class="menu-item">
          <i class="fas fa-bullhorn"></i>
          <span class="menu-text">Announcement</span>
          <span class="tooltip">Announcement</span>
        </a>
        <a href="{{ url_for('lecturer_profile') }}" class="menu-item">
          <i class="fas fa-calendar-day"></i>
          <span class="menu-text">Profile</span>
          <span class="tooltip">Profile</span>
        </a>
        <a href="{{ url_for('lecturer_settings') }}" class="menu-item">
          <i class="fas fa-cog"></i>
          <span class="menu-text">Settings</span>
          <span class="tooltip">Settings</span>
        </a>

        <div class="menu-category">About</div>
        <a href="{{ url_for('lecturer_about') }}" class="menu-item">
          <i class="fas fa-info-circle"></i>
          <span class="menu-text">About Us</span>
          <span class="tooltip">About Us</span>
        </a>
      </div>
    </div>

    <!-- Main content -->
    <div class="main-content">
      <div class="card">
        <h1>Dashboard</h1>
        <p>Welcome To TapIn!
            <br>Your smart attendance dashboard is ready.
            Track and manage your classes with precision.</p>
      </div>

      <section>
        <div class="create_class_button">
            <button id="createClassBtn" title="Create Class">+</button>
        </div>
        <div id="classList" class="class-list">
            <!-- Classes will load here dynamically -->
        </div>
      </section>
    </div>

    <!-- Create Class Modal -->
    <div id="classFormContainer" class="modal">
        <div class="modal-content">
            <span id="closeForm" class="close">&times;</span>
            <h2>Create a Class</h2>
            <form id="classForm">
                <label>Class Name</label>
                <input type="text" name="className" required>
                
                <label>Programme</label>
                <input type="text" name="programme" required>
                
                <label>Faculty</label>
                <input type="text" name="faculty" required>
                
                <label>Department</label>
                <input type="text" name="department" required>
                
                <label>Course Name</label>
                <input type="text" name="courseName" required>
                
                <label>Course Code</label>
                <input type="text" name="courseCode" required>
                
                <label>Level</label>
                <select name="level" required>
                    <option value="">Select Level</option>
                    <option>100</option>
                    <option>200</option>
                    <option>300</option>
                    <option>400</option>
                </select>
                
                <label>Section</label>
                <select name="section" required>
                    <option value="">Select Section</option>
                    <option>Full Time (Morning)</option>
                    <option>Part Time (Evening)</option>
                    <option>Distance (Weekend)</option>
                </select>
                <label>Join PIN</label>
                <input type="text" name="joinPin" readonly>
                <button type="button" id="generatePin" class="btn-secondary">Generate PIN</button>
                <button type="submit" class="btn-primary">Create Class</button>
            </form>
        </div>
    </div>

<script>
    document.addEventListener("DOMContentLoaded", () => {
        // Global auth handles init; proceed directly
        const classList = document.getElementById("classList");
        const modal = document.getElementById("classFormContainer");
        const form = document.getElementById("classForm");
        const createBtn = document.getElementById("createClassBtn");
        const closeBtn = document.getElementById("closeForm");
        const generatePinBtn = document.getElementById("generatePin");

        // Reusable API helper using auth manager
        const api = async (path, options = {}) => {
            return await authManager.apiCall(path, options);
        };

        // Load classes from backend
        async function loadClasses() {
            console.log('[LECTURER HOME DEBUG] loadClasses() starting - token present:', !!authManager.getToken());
            try {
                console.log('[LECTURER HOME DEBUG] Calling api("/api/classes")...');
                const res = await api('/api/classes');
                console.log('[LECTURER HOME DEBUG] /api/classes response:', { hasError: !!res.error, dataLength: res ? res.length : 'none' });
                classList.innerHTML = '';

                if (!res || res.length === 0) {
                    classList.innerHTML = "<p style='color:#888;'>No classes created yet.</p>";
                    return;
                }

                res.forEach(cls => {
                    const div = document.createElement('div');
                    div.classList.add('class-item');
                    div.innerHTML = `
                    <div class="class-info" onclick="window.location.href='/lecturer/class/${cls.id}'">
                        <h3>${cls.course_name}</h3>
                        <p>${cls.programme} - ${cls.level} (${cls.section})</p>
                        <small>PIN: ${cls.join_pin}</small>
                    </div>
                    <button class="delete-btn" onclick="deleteClassBackend(${cls.id})">âœ–</button>
                `;
                    classList.appendChild(div);
                });
            } catch (err) {
                console.log('[LECTURER HOME DEBUG] /api/classes error caught:', { error: err, message: err.message || err.error });
                let errorMessage = 'Failed to load classes. Please try again.';
                if (err && err.error) {
                    errorMessage = err.error;
                    console.log('[LECTURER HOME DEBUG] Error message:', errorMessage, '- contains "Session expired":', errorMessage.includes('Session expired'));
                    if (errorMessage.includes('Session expired')) {
                        alert('Your session has expired. Please log in again.');
                        window.location.href = '/account';
                        return;
                    }
                }
                classList.innerHTML = `<p style='color:red;'>${errorMessage}</p>`;
                console.error('Load classes error:', err);
                console.log('[LECTURER HOME DEBUG] loadClasses() ended with error');
            }
            console.log('[LECTURER HOME DEBUG] loadClasses() completed successfully');
        }

        // Delete class
        window.deleteClassBackend = async (classId) => {
            if (!confirm("Are you sure you want to delete this class?")) return;
            try {
                const res = await api(`/api/classes/${classId}`, { method: 'DELETE' });
                if (res.error) {
                    alert(res.error);
                } else {
                    alert("Class deleted successfully!");
                    loadClasses();
                }
            } catch (err) {
                alert('Failed to delete class.');
                console.error(err);
            }
        };

        // Create new class
    // Add logging for debugging create class
    console.log('Form data before submit:', {
        programme: form.programme.value,
        faculty: form.faculty.value,
        department: form.department.value,
        course_name: form.courseName.value,
        course_code: form.courseCode.value,
        level: form.level.value,
        section: form.section.value,
        join_pin: form.joinPin.value || Math.floor(100000 + Math.random() * 900000).toString()
    });
        form.addEventListener("submit", async (e) => {
            e.preventDefault();
            const classData = {
                programme: form.programme.value,
                faculty: form.faculty.value,
                department: form.department.value,
                course_name: form.courseName.value,
                course_code: form.courseCode.value,
                level: form.level.value,
                section: form.section.value,
                join_pin: form.joinPin.value || Math.floor(100000 + Math.random() * 900000).toString()
            };
            try {
                const res = await api('/api/classes', {
                    method: 'POST',
                    body: JSON.stringify(classData)
                });
                if (res.error) {
                    alert(res.error);
                } else {
                    alert("Class created successfully!");
                    form.reset();
                    modal.style.display = 'none';
                    loadClasses();
                }
            } catch (err) {
                alert("Failed to create class.");
                console.error(err);
            }
        });

        // Open/close modal
        createBtn.addEventListener("click", () => modal.style.display = "flex");
        closeBtn.addEventListener("click", () => modal.style.display = "none");

        // Generate random PIN
        generatePinBtn.addEventListener("click", () => {
            form.joinPin.value = Math.floor(100000 + Math.random() * 900000);
        });

        // Load data initially
        loadClasses();

        // Sidebar + theme toggle
        const toggleBtn = document.getElementById("toggleBtn");
        const sidebar = document.getElementById("sidebar");
        if (localStorage.getItem("sidebarCollapsed") === "true") {
            sidebar.classList.add("collapsed");
            toggleBtn.querySelector("i").classList.replace("fa-bars", "fa-chevron-right");
        }

        toggleBtn.addEventListener("click", () => {
            sidebar.classList.toggle("collapsed");
            const icon = toggleBtn.querySelector("i");
            if (sidebar.classList.contains("collapsed")) {
                icon.classList.replace("fa-bars", "fa-chevron-right");
                localStorage.setItem("sidebarCollapsed", "true");
            } else {
                icon.classList.replace("fa-chevron-right", "fa-bars");
                localStorage.setItem("sidebarCollapsed", "false");
            }
        });

        window.addEventListener("resize", () => {
            if (window.innerWidth <= 768) sidebar.classList.add("collapsed");
        });
    });
</script>


    <script src="{{ url_for('static', filename='\1') }}"></script>
</body>
</html>
