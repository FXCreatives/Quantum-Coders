<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Lecturer Profile</title>
  <link rel="icon" href="/static/pics/attendance_app_icon.png" type="image/png">
  <link rel="stylesheet" href="/static/css/lecturer_page_css/menu.css">
  <link rel="stylesheet" href="/static/css/lecturer_page_css/lecturer_style.css">

  <script>
    (function () {
      if (localStorage.getItem("darkMode") === "true") {
        document.documentElement.classList.add("dark-mode");
      }
    })();
  </script>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" />
  <style>
    .profile-wrap {
      display: grid;
      gap: 16px;
      grid-template-columns: 220px 1fr;
    }

    .avatar-card,
    .info-card {
      background: #FFF8E7;
      border: 1px solid rgba(184, 134, 11, 0.25);
      border-radius: 10px;
      padding: 16px;
    }

    .avatar {
      width: 180px;
      height: 180px;
      border-radius: 50%;
      object-fit: cover;
      display: block;
      margin: 0 auto 12px;
      border: 3px solid goldenrod;
    }

    .file-input {
      display: none;
    }

    html.dark-mode .info-card {
      color: rgb(0, 0, 0);
    }

    .actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    @media (max-width:748px) {
      .profile-wrap {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>

<body>
  <!-- Navbar -->
  <section class="nav_bar_section">
    <nav class="navbar">
      <div class="navdiv">
        <div class="logo"></div>
        <div class="nav_links">
          <button class="theme-toggle" id="themeToggle">
            <i class="fas fa-moon"></i>
            <p id="mode-btn" class="mode-btn-text">Dark mode</p>
          </button>
          <a href="{{ url_for('lecturer_notification') }}"><i class="far fa-bell"></i><span>Notification</span></a>
          <a href="{{ url_for('lecturer_profile') }}"><i class="far fa-user"></i><span>Profile</span></a>
        </div>
      </div>
    </nav>
  </section>

  <!-- Sidebar -->
  <div class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <button class="toggle-btn" id="toggleBtn"><i class="fas fa-bars"></i></button>
      <h2>Edu-Portal</h2>
    </div>
    <div class="menu">
      <div class="menu-category">Home</div>
      <a href="{{ url_for('lecturer_initial_home') }}" class="menu-item">
        <i class="fas fa-home"></i><span class="menu-text">Home</span><span class="tooltip">Home</span>
      </a>
      <div class="menu-category">Academic</div>
      <a href="{{ url_for('lecturer_dashboard') }}" class="menu-item"><i class="fas fa-book"></i><span class="menu-text">My
        Classes</span></a>
      <div class="menu-category">Lecturer Info</div>
      <a href="{{ url_for('lecturer_announcements') }}" class="menu-item"><i class="fas fa-bullhorn"></i><span
        class="menu-text">Announcement</span></a>
      <a href="{{ url_for('lecturer_profile') }}" class="menu-item active"><i class="fas fa-user"></i><span
        class="menu-text">Profile</span></a>
      <a href="{{ url_for('lecturer_settings') }}" class="menu-item"><i class="fas fa-cog"></i><span
        class="menu-text">Settings</span></a>
<a href="{{ url_for('logout') }}" class="menu-item"><i class="fas fa-sign-out-alt"></i><span class="menu-text">Logout</span><span class="tooltip">Logout</span></a>
      <div class="menu-category">About</div>
      <a href="{{ url_for('lecturer_about') }}" class="menu-item"><i class="fas fa-info-circle"></i><span class="menu-text">About
        Us</span></a>
    </div>
  </div>

  <!-- Main -->
  <div class="main-content">
    <div class="card">
      <h1>My Profile</h1>
      <div class="profile-wrap">
        <div class="avatar-card">
          <img id="avatarImg" class="avatar" alt="Avatar" src="/static/pics/profile_whitebg.png">
          <div class="actions">
            <label for="avatarInput" class="btn-secondary" style="cursor:pointer;">Upload Photo</label>
            <input id="avatarInput" class="file-input" type="file" accept="image/*">
            <button id="removeAvatar" class="btn-primary">Remove Photo</button>
          </div>
        </div>
        <div class="info-card">
          <h3>Lecturer Details</h3>
          <div id="profileFields">
            <p><strong>Name:</strong> <span id="pf_name">—</span></p>
            <p><strong>Email:</strong> <span id="pf_email">—</span></p>
            <p><strong>Phone:</strong> <span id="pf_phone">—</span></p>
          </div>
          <div class="actions" style="margin-top:12px;">
            <a href="{{ url_for('lecturer_settings') }}" class="btn-secondary">Edit in Settings</a>
            <a href="{{ url_for('logout') }}" class="btn-secondary">Logout</a>
            <button id="exportProfile" class="btn-primary">Export Profile JSON</button>
          </div>
          <hr style="margin:16px 0;">
          <h3>Quick Links</h3>
          <div class="actions">
            <a href="{{ url_for('lecturer_dashboard') }}" class="btn-secondary">My Courses</a>
          </div>
        </div>
      </div>
    </div>
  </div>

 
  <script src="/static/js/auth.js"></script>
   <script>
    function applyThemeFromStorage() {
    const themeToggle = document.getElementById("themeToggle");
    const modeBtnText = document.getElementById("mode-btn");
    const html = document.documentElement;

    if (localStorage.getItem("darkMode") === "true") {
        html.classList.add("dark-mode");
        if (themeToggle) themeToggle.querySelector("i").classList.replace("fa-moon", "fa-sun");
        if (modeBtnText) modeBtnText.textContent = "Light mode";
    } else {
        html.classList.remove("dark-mode");
        if (themeToggle) themeToggle.querySelector("i").classList.replace("fa-sun", "fa-moon");
        if (modeBtnText) modeBtnText.textContent = "Dark mode";
    }
}

document.addEventListener("DOMContentLoaded", applyThemeFromStorage);

document.addEventListener("DOMContentLoaded", function () {
    const themeToggle = document.getElementById("themeToggle");
    const modeBtnText = document.getElementById("mode-btn");
    const html = document.documentElement;

    if (themeToggle) {
        themeToggle.addEventListener("click", () => {
            html.classList.toggle("dark-mode");

            const icon = themeToggle.querySelector("i");
            const isDark = html.classList.contains("dark-mode");
            if (isDark) {
                icon.classList.replace("fa-moon", "fa-sun");
                if (modeBtnText) modeBtnText.textContent = "Light mode";
            } else {
                icon.classList.replace("fa-sun", "fa-moon");
                if (modeBtnText) modeBtnText.textContent = "Dark mode";
            }
            localStorage.setItem("darkMode", isDark ? "true" : "false");
        });
    }
});

   </script>
  <script>
    document.addEventListener("DOMContentLoaded", async () => {
      await authManager.init();
  
      const toggleBtn = document.getElementById("toggleBtn");
      const sidebar = document.getElementById("sidebar");
  
      const avatarImg = document.getElementById("avatarImg");
      const avatarInput = document.getElementById("avatarInput");
      const removeAvatarBtn = document.getElementById("removeAvatar");
  
      const pf_name = document.getElementById("pf_name");
      const pf_email = document.getElementById("pf_email");
      const pf_phone = document.getElementById("pf_phone");
  
      const exportBtn = document.getElementById("exportProfile");
  
      if (!authManager.isAuthenticated()) {
        window.location.href = '/account';
        return;
      }
  
      // Null checks
      if (!toggleBtn || !sidebar) {
        console.warn('[PROFILE] Sidebar elements missing');
        return;
      }
      if (!avatarImg || !avatarInput || !removeAvatarBtn) {
        console.warn('[PROFILE] Avatar elements missing');
      }
      if (!pf_name || !pf_email || !pf_phone) {
        console.warn('[PROFILE] Profile fields missing');
      }
      if (!exportBtn) {
        console.warn('[PROFILE] Export button missing');
      }
  
      // -------------------
      // Sidebar state
      // -------------------
      if (localStorage.getItem("sidebarCollapsed") === "true") {
        sidebar.classList.add("collapsed");
        toggleBtn.querySelector("i").classList.replace("fa-bars", "fa-chevron-right");
      }
      toggleBtn.addEventListener("click", () => {
        sidebar.classList.toggle("collapsed");
        const icon = toggleBtn.querySelector("i");
        if (sidebar.classList.contains("collapsed")) {
          icon.classList.replace("fa-bars", "fa-chevron-right");
          localStorage.setItem("sidebarCollapsed", "true");
        } else {
          icon.classList.replace("fa-chevron-right", "fa-bars");
          localStorage.setItem("sidebarCollapsed", "false");
        }
      });
      const checkScreen = () => { if (window.innerWidth <= 768) sidebar.classList.add("collapsed"); };
      window.addEventListener("resize", checkScreen);
      checkScreen();
  
      // -------------------
      // Load profile
      // -------------------
      const loadProfile = async () => {
        const data = await authManager.apiCall('/auth/me');
        if (data.error) {
          console.error('[PROFILE] Failed to load profile:', data.error);
          return;
        }
        if (pf_name) pf_name.textContent = data.fullname || "Not set";
        if (pf_email) pf_email.textContent = data.email || "Not set";
        if (pf_phone) pf_phone.textContent = data.phone || "Not set";
        if (avatarImg) avatarImg.src = data.avatar_url || "/static/pics/profile_whitebg.png";
      };
  
      await loadProfile();

      // -------------------
      // Export profile JSON
      // -------------------
      if (exportBtn) {
        exportBtn.addEventListener("click", async () => {
          const data = await authManager.apiCall("/api/auth/me");
          const blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url; a.download = "lecturer_profile.json";
          document.body.appendChild(a); a.click();
          URL.revokeObjectURL(url); a.remove();
        });
      }
  
      // -------------------
      // Upload avatar
      // -------------------
      if (avatarInput) {
        avatarInput.addEventListener("change", async (e) => {
          const file = e.target.files[0];
          if (!file) return;
  
          const formData = new FormData();
          formData.append("avatar", file);
  
          const res = await fetch("/api/auth/avatar", {
            method: "POST",
            headers: { "Authorization": `Bearer ${authManager.getToken()}` },
            body: formData
          });
  
          const result = await res.json();
          if (result.success) {
            if (avatarImg) avatarImg.src = result.avatar_url;
          } else {
            alert(result.error || "Failed to upload avatar");
          }
        });
      }
  
      // -------------------
      // Remove avatar
      // -------------------
      if (removeAvatarBtn) {
        removeAvatarBtn.addEventListener("click", async () => {
          const res = await fetch("/api/auth/avatar", {
            method: "DELETE",
            headers: { "Authorization": `Bearer ${authManager.getToken()}` }
          });
          const result = await res.json();
          if (result.success) {
            if (avatarImg) avatarImg.src = "/static/pics/profile_whitebg.png";
          }
        });
      }
    });

</script>

  </body>
  
  </html>