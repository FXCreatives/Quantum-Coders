<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Student Settings</title>
    <link rel="icon" href="/static/pics/attendance_app_icon.png" type="image/png">
    <link rel="stylesheet" href="/static/css/student_page_css/menu.css">
    <link rel="stylesheet" href="/static/css/student_page_css/student_style.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" />

    <script>
        // Apply dark mode immediately
        (function () {
            if (localStorage.getItem("darkMode") === "true") {
                document.documentElement.classList.add("dark-mode");
            }
        })();
    </script>

    <style>
        .card {
            background-color: beige;
            padding: 2rem;
            border-radius: 12px;
            max-width: 500px;
            margin-left: 20px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }

        input {
            width: 100%;
            padding: 0.6rem 0.8rem;
            margin-bottom: 1rem;
            border: 1px solid #ccc;
            border-radius: 8px;
            box-sizing: border-box;
        }

        label {
            font-weight: 600;
            margin-bottom: 0.3rem;
            display: block;
        }

        .btn-primary {
            width: 100%;
            padding: 0.8rem;
            background-color: #007bff;
            color: #fff;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .btn-primary:hover {
            background-color: #0056b3;
        }

        .sidebar {
            transition: all 0.3s ease;
            width: 250px;
        }

        .sidebar.collapsed {
            width: 60px;
        }

        .sidebar .menu-text {
            display: inline;
        }

        .sidebar.collapsed .menu-text {
            display: none;
        }

        .sidebar~.card {
            margin-left: 290px;
        }

        @media(max-width:748px) {
            .card {
                max-width: 300px;
            }

            .sidebar.collapsed~.card {
                margin-left: 290px;
            }

            .sidebar {
                width: 220px;
            }
        }
    </style>
</head>

<body>

    <!-- Navbar -->
<section class="nav_bar_section">
    <nav class="navbar">
        <div class="navdiv">
            <div class="logo"></div>
            <div class="nav_links">
                <button class="theme-toggle" id="themeToggle">
                    <i class="fas fa-moon"></i>
                    <p id="mode-btn" class="mode-btn-text">Dark mode</p>
                </button>
                <a href="student_notification.html">
                    <i class="far fa-bell"></i>
                    <span>Notification</span>
                </a>
                <a href="student_profile.html">
                    <i class="far fa-user"></i>
                    <span>Profile</span>
                </a>
            </div>
        </div>
    </nav>
</section>

<div class="sidebar" id="sidebar">
    <div class="sidebar-header">
        <button class="toggle-btn" id="toggleBtn">
            <i class="fas fa-bars"></i>
        </button>
        <h2>Edu-Portal</h2>
    </div>

    <div class="menu">
        <div class="menu-category">Home</div>
        <a href="student_home.html" class="menu-item">
            <i class="fas fa-home"></i>
            <span class="menu-text">Home</span>
            <span class="tooltip">Home</span>
        </a>

        <div class="menu-category">Student Info</div>
        <a href="student_class.html" class="menu-item">
            <i class="fas fa-chalkboard"></i>
            <span class="menu-text">Class</span>
            <span class="tooltip">Class</span>
        </a>
        <a href="student_profile.html" class="menu-item">
            <i class="far fa-user"></i>
            <span class="menu-text">Profile</span>
            <span class="tooltip">Profile</span>
        </a>
        <a href="#" class="menu-item active">
            <i class="fas fa-cog"></i>
            <span class="menu-text">Settings</span>
            <span class="tooltip">Settings</span>
        </a>

        <div class="menu-category">About</div>
        <a href="student_about.html" class="menu-item">
            <i class="fas fa-info-circle"></i>
            <span class="menu-text">About Us</span>
            <span class="tooltip">About Us</span>
        </a>
    </div>
</div>

    <!-- Main -->
    <div class="main-content">
        <div class="card">
            <h1>Settings</h1>
            <form id="settingsForm">
                <label>Name</label>
                <input type="text" name="name" required>

                <label>Phone Number</label>
                <input type="tel" name="phone">

                <label>Change Password</label>
                <input type="password" name="password">

                <button type="submit" class="btn-primary">Save Settings</button>
            </form>
        </div>
    </div>

    <script src="/static/js/student_page_js/theme.js"></script>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const sidebar = document.getElementById("sidebar");
            const toggleBtn = document.getElementById("toggleBtn");
            const form = document.getElementById("settingsForm");
            const TOKEN = sessionStorage.getItem("tapin_token");

            // Sidebar toggle
            if (localStorage.getItem("sidebarCollapsed") === "true") {
                sidebar.classList.add("collapsed");
                toggleBtn.querySelector("i").classList.replace("fa-bars", "fa-chevron-right");
            }
            toggleBtn.addEventListener("click", () => {
                sidebar.classList.toggle("collapsed");
                const icon = toggleBtn.querySelector("i");
                if (sidebar.classList.contains("collapsed")) {
                    icon.classList.replace("fa-bars", "fa-chevron-right");
                    localStorage.setItem("sidebarCollapsed", "true");
                } else {
                    icon.classList.replace("fa-chevron-right", "fa-bars");
                    localStorage.setItem("sidebarCollapsed", "false");
                }
            });

            // Load current settings
            async function loadSettings() {
                const res = await fetch("/api/student/me", {
                    headers: { "Authorization": `Bearer ${TOKEN}` }
                });
                const data = await res.json();
                form.name.value = data.name;
                form.phone.value = data.phone || "";
            }
            loadSettings();

            // Submit updated settings
            form.addEventListener("submit", async function (e) {
                e.preventDefault();
                const payload = {
                    name: form.name.value,
                    phone: form.phone.value
                };
                if (form.password.value) payload.password = form.password.value;

                const res = await fetch("/api/student/settings", {
                    method: "PATCH",
                    headers: {
                        "Authorization": `Bearer ${TOKEN}`,
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify(payload)
                });
                const data = await res.json();
                if (data.success) {
                    alert("Settings updated successfully!");
                    form.password.value = ""; // clear password
                } else {
                    alert("Error updating settings!");
                }
            });

            // Dark mode toggle
            document.getElementById("themeToggle").addEventListener("click", () => {
                document.documentElement.classList.toggle("dark-mode");
                localStorage.setItem("darkMode", document.documentElement.classList.contains("dark-mode"));
            });
        });
    </script>
</body>

</html>